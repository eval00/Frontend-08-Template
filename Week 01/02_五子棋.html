<style>
    .container {
        display: inline-block;
        position: relative;
        background-color: #f8e7b9;
    }
    .mask {
        position: absolute;
        top: 0;
        box-sizing: border-box;
        width: 100%;
        height: 100%;
        border: 24px solid #f8e7b9;
    }
    .cell {
        position: relative;
        display: inline-block;
        width: 50px;
        height: 50px;
        text-align: center;
    }
    .cell>div {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
    }
    .line {
        background-color: black;
    }
    .line.heng {
        width: 100%;
        height: 2px;
    }
    .line.shu {
        width: 2px;
        height: 100%;
    }
    .dot {
        width: 10px;
        height: 10px;
        border-radius: 50%;
        background-color: black;
    }
    .disc {
        z-index: 1;
        width: 40px;
        height: 40px;
        border-radius: 50%;
        /* debug */
        font-size: 10px;
        background-color: gray;
        color: lightsalmon;
    }
    .disc.black {
        border: 2px solid black;
        background-color: #333;
    }
    .disc.white {
        border: 2px solid black;
        background-color: white;
    }
    .disc.red {
        border: 2px solid black;
        background-color: red;
    }
</style>

<div class="container">
    <div class="board"></div>
    <div class="mask"></div>
</div>

<script>
    function show(board, pattern) {
        let p2v = ['', 'black', 'white', 'red'];
        let discs = board.querySelectorAll('.disc');
        for(let i = 0; i < 15 * 15; i++) {
            let d = discs[i];
            let p = pattern[i];
            let className = p2v[p];
            d.classList.value = `disc ${className}`;
        }
    }

    function checkWin(pattern, color, x, y) {
        function numberOfSameDisc(x, y, vx, vy) {
            let count = 0;
            for(let i = 0; i < 4; i++) {
                x += vx;
                y += vy;
                let index = y * 15 + x;
                if((x < 0 || x > 14 || y < 0 || y > 14) || pattern[index] !== color) {
                    break;
                }
                count++;
            }
            return count;
        }
        let a = [
            [-1, 0, 1, 0],
            [0, -1, 0, 1],
            [1, -1, -1, 1],
            [-1, -1, 1, 1],
        ]
        for(let i of a) {
            if(numberOfSameDisc(x, y, i[0], i[1]) + numberOfSameDisc(x, y, i[2], i[3]) === 4) {
                return true;
            }
        }
    }

    function clone(pattern) {
        return Object.create(pattern);
    }

    function willWin(pattern, color) {
        for(let i = 0; i < 15; i++) {
            for(let j = 0; j < 15; j++) {
                if(pattern[i * 15 + j]) {
                    continue;
                }
                let t = clone(pattern);
                t[i * 3 + j] = color;
                if(checkWin(t, color, j, i)) {
                    return [j, i];
                }
            }
        }
        return null;
    }

    function aroundPointsFrom(pattern, ox, oy) {
        let r = [];
        let vs = [
            [-1, -1],
            [0, -1],
            [1, -1],
            [-1, 0],
            [1, 0],
            [-1, 1],
            [0, 1],
            [1, 1],
        ]
        for(let v of vs) {
            let x = ox + v[0];
            let y = oy + v[1];
            if((x < 0 || x > 14 || y < 0 || y > 14) || pattern[y * 15 + x] !== 0) {
                continue;
            }
            r.push([x, y]);
        }
        return r;
    }

    function bestChoice(pattern, color, maxDepth = 4, root) {
        if(maxDepth-- === 0) {
            return {
                point: null,
                result: 0
            }
        }
        let p = willWin(pattern, color);
        if(p) {
            return {
                point: p,
                result: 1
            };
        }
        // 选点
        let ps = []
        for(let i = 0; i < 15; i++) {
            for(let j = 0; j < 15; j++) {
                if(pattern[i * 15 + j] === 0) {
                    continue;
                }
                ps = ps.concat(aroundPointsFrom(pattern, j, i));
            }
        }

        let result = -2;
        let point = null;
        let set = new Set();
        for(let p of ps) {
            let [x, y] = p;
            if(set.has(y * 15 + x)) {
                continue;
            }
            // 
            let t = clone(pattern);
            t[y * 15 + x] = color;
            let node = {
                board: stringFrom(t, color),
                children: []
            }
            root.children.push(node);
            let r = bestChoice(t, 3 - color, maxDepth, node).result;
            if(-r > result) {
                result = -r;
                point = [x, y];
            }
            // 剪纸
            if(result === 1) {
                break;
            }

            set.add(y * 15 + x);
        }
        return {
            point: point,
            result: point ? result : 0
        }
    }

    function stringFrom(pattern, color) {
        let s = color + '\n';
        for(let i = 0; i < 15; i++) {
            for(let j = 0; j < 15; j++) {
                s += pattern[i * 15 + j];
            }
            s += '\n';
        }
        return s;
    }

    function main() {
        let pattern = [
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
            0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,
        ];
        let color = 1;

        let board = document.querySelector('.board');

        // 显示棋盘
        let dots = [15 * 3 + 3, 15 * 4 - 4, 15 * 11 + 3, 15 * 12 - 4, 15 * 7 + 7];
        for(let i = 0; i < 15; i++) {
            for(let j = 0; j < 15; j++) {
                let dot = '';
                if(dots.includes(i * 15 + j)) {
                    dot = '<div class="dot"></div>';
                }
                let cell = `<div class='cell'>
                    <div class='line heng'></div>
                    <div class='line shu'></div>
                    ${dot}
                    <div class='disc' data-x=${j} data-y=${i}>
                        ${j} ${i}<br>
                        ${i * 15 + j}    
                    </div>
                </div>`
                board.innerHTML += cell;
            }
            board.innerHTML += '<br>';
        }

        show(board, pattern);

        // 落子
        board.addEventListener('click', function(e) {
            let p2v = ['', 'black', 'white', 'red'];
            let target = e.target;
            let x = Number(target.dataset.x);
            let y = Number(target.dataset.y);
            pattern[y * 15 + x] = color;
            if(checkWin(pattern, color, x, y)) {
                alert(p2v[color] + ' win');
            }

            color = 3 - color;
            show(board, pattern);
            let root = {
                board: stringFrom(pattern, color),
                children: []
            };
            console.log(p2v[color], bestChoice(pattern, color, 4, root));
            console.log(root);
        });
    }

    main();
</script>